## Product Funnel Analysis

Using a single SQL query - create a new output table which has the following details:

- How many times was each product viewed?
- How many times was each product added to cart?
- How many times was each product added to a cart but not purchased (abandoned)?
- How many times was each product purchased?

````sql
WITH PageView_CartAdd AS (
SELECT b.product_id, 
       b.page_name AS product_name,	
       SUM(CASE WHEN a.event_type = 1 THEN 1 ELSE 0 END) AS page_views,
       SUM(CASE WHEN a.event_type = 2 THEN 1 ELSE 0 END) AS cart_adds
       FROM clique_bait.events a
       JOIN clique_bait.page_hierarchy b ON a.page_id = b.page_id
       AND product_id IS NOT NULL
 GROUP BY b.product_id, b.page_name
 ORDER BY b.product_id
 ),
  
  
abandoned_evnets AS (
SELECT b.product_id, 
       b.page_name AS product_name,
       COUNT(a.page_id) AS abandoned
  FROM clique_bait.events a
  JOIN clique_bait.page_hierarchy b ON a.page_id = b.page_id 
  WHERE visit_id NOT IN  
	    (SELECT visit_id
	       FROM clique_bait.events
	      WHERE event_type = 3)   -- filter visit_id to find out customers who don't have purchase events
  AND a.event_type = 2
  AND b.product_id IS NOT NULL
GROUP BY b.product_id, b.page_name
ORDER BY b.product_id
 ),
    
purchase_events AS (
SELECT b.product_id, 
       b.page_name AS product_name,
       COUNT(a.page_id) AS purchases
  FROM clique_bait.events a
  JOIN clique_bait.page_hierarchy b ON a.page_id = b.page_id 
  WHERE visit_id IN  
	    (SELECT visit_id
	       FROM clique_bait.events
	      WHERE event_type = 3)   -- filter visit_id to find out customers who have purchase events
  AND a.event_type = 2
  AND b.product_id IS NOT NULL
GROUP BY b.product_id, b.page_name
ORDER BY b.product_id
 )
    
 -- combine the 3 derived tables above
  
 SELECT  e.*, f.abandoned, g.purchases
 FROM PageView_CartAdd e
 JOIN abandoned_evnets f ON e.product_id = f.product_id
 JOIN purchase_events g ON e.product_id = g.product_id
````

**Answer:**

<img width="650" alt="image" src="https://user-images.githubusercontent.com/61902789/144624231-72209e2e-4297-4d1d-8685-a84a2c07d4d5.png">


Additionally, create another table which further aggregates the data for the above points but this time for each product category instead of individual products.

Use your 2 new output tables - answer the following questions:

1. Which product had the most views, cart adds and purchases?
2. Which product was most likely to be abandoned?
3. Which product had the highest view to purchase percentage?
4. What is the average conversion rate from view to cart add?
5. What is the average conversion rate from cart add to purchase?

***
